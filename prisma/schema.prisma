// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User/Account management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Business/Sales Configuration (moved from env)
  salesName     String?
  salesEmail    String?
  companyName   String?
  emailSignature String? @db.Text
  
  // Business hours and preferences
  businessHoursStart String @default("09:00")
  businessHoursEnd   String @default("17:00") 
  workingDays        Int[]  @default([1, 2, 3, 4, 5]) // Monday-Friday
  timezone           String @default("UTC")
  
  // Meeting preferences
  meetingDuration    Int    @default(30) // minutes
  bufferTime         Int    @default(15) // minutes between meetings

  // Google OAuth tokens
  googleTokens GoogleTokens?

  // User's processed emails
  emails EmailRecord[]

  // User's calendar events (created by the assistant)
  calendarEvents CalendarEventRecord[]

  // Scheduled responses
  scheduledResponses ScheduledResponse[]

  @@map("users")
}

// Store Google OAuth tokens securely
model GoogleTokens {
  id           String    @id @default(uuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accessToken  String
  refreshToken String?
  tokenType    String    @default("Bearer")
  scope        String?
  expiresAt    DateTime?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("google_tokens")
}

// Store processed emails
model EmailRecord {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Gmail message info
  gmailMessageId  String   @unique
  gmailThreadId   String
  messageIdHeader String?  // RFC 2822 Message-ID header for proper threading
  
  // Email content
  from            String
  to              String
  subject         String
  body            String   @db.Text
  receivedAt      DateTime
  direction       EmailDirection @default(INBOUND)
  
  // Processing status
  processedAt     DateTime?
  processingStatus ProcessingStatus @default(PENDING)
  
  // AI Analysis results
  isDemoRequest   Boolean?
  
  // Response information
  responseGenerated Boolean @default(false)
  responseSent      Boolean @default(false)
  responseMessageId String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Related calendar events
  calendarEvents  CalendarEventRecord[]

  // Scheduled responses
  scheduledResponses ScheduledResponse[]

  @@index([userId, processedAt])
  @@index([gmailMessageId])
  @@index([processingStatus])
  @@index([messageIdHeader])
  @@map("email_records")
}

// Store scheduled email responses (draft/queued for sending)
model ScheduledResponse {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Related email
  emailRecordId   String
  emailRecord     EmailRecord @relation(fields: [emailRecordId], references: [id], onDelete: Cascade)
  
  // Response details
  recipientEmail  String
  recipientName   String?
  subject         String
  body            String   @db.Text
  
  // Proposed time slots (JSON array)
  proposedTimeSlots Json
  
  // Scheduling
  scheduledAt     DateTime  // When to send
  status          ResponseStatus @default(DRAFT)
  
  // Email sending
  sentAt          DateTime?
  sentMessageId   String?   // Gmail message ID after sending
  
  // User interaction
  lastEditedAt    DateTime?
  editedBy        String?   // User ID who last edited
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, scheduledAt])
  @@index([status, scheduledAt])
  @@map("scheduled_responses")
}

// Store calendar events created by the assistant
model CalendarEventRecord {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Related email (if created from email)
  emailRecordId     String?
  emailRecord       EmailRecord? @relation(fields: [emailRecordId], references: [id], onDelete: SetNull)
  
  // Google Calendar info
  googleEventId     String
  calendarId        String   @default("primary")
  
  // Event details
  summary           String
  startTime         DateTime
  endTime           DateTime
  timezone          String
  
  // Attendee information
  attendeeEmail     String
  attendeeName      String?
  
  // Event status
  status            CalendarEventStatus @default(CONFIRMED)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([googleEventId, calendarId])
  @@index([userId, startTime])
  @@index([attendeeEmail])
  @@map("calendar_event_records")
}


// Enums
enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum ResponseStatus {
  DRAFT          // Created, waiting for scheduled time
  SCHEDULED      // Ready to send at scheduled time
  SENT           // Successfully sent
  CANCELLED      // User cancelled
  FAILED         // Failed to send
  EDITING        // User is currently editing
  EXPIRED        // Too old to send (6+ hours)
}

enum CalendarEventStatus {
  CONFIRMED
  TENTATIVE
  CANCELLED
}

enum EmailDirection {
  INBOUND   // Emails received by the user
  OUTBOUND  // Emails sent by the user
}

